import{U as J,A as G,N as z}from"./Navigation-CF_cJcsH.js";import{_ as D,K as V,a1 as k,b as $,w as a,ay as A,o as f,a as l,az as U,ac as K,d as T,ad as C,ae as P,l as v,t as d,af as L,aA as N,f as o,c,F as w,a3 as O,aB as Y,b7 as Q,aC as X,a2 as Z,r as b,V as q,e as I,G as x,am as _,a4 as ee,aF as H,aG as R,aH as M,T as te,aI as W,h as p,n as E,j as le,Y as ie,aJ as ae,I as se,aK as ne,i as re,a8 as de,a9 as B,aD as oe,aE as j}from"../index.js";import{H as ue,A as me}from"./utils-25EARmsx.js";import{F as he,E as fe}from"./ElementListItems-BQUTI6r5.js";const ge={props:{item:{type:Object,required:!0}},emits:[],data:()=>({panel:[0,1,2],versions:{},element:{}}),setup(){return{auth:k()}},watch:{item:{immediate:!0,handler(e){!e.id||!this.auth.can("element:view")||this.$apollo.query({query:V`query ($id: ID!) {
              element(id: $id) {
                id
                bypages {
                  id
                  path
                  name
                }
                byversions {
                  id
                  versionable_id
                  versionable_type
                  published
                  publish_at
                }
              }
            }`,variables:{id:e.id}}).then(t=>{var i,n,m;if(t.errors)throw t.errors;this.element=((i=t.data)==null?void 0:i.element)||{},this.versions=(((m=(n=t.data)==null?void 0:n.element)==null?void 0:m.byversions)||[]).map(s=>({id:s.versionable_id,type:s.versionable_type.split("\\").at(-1),published:s.published?this.$gettext("yes"):s.publish_at?new Date(s.publish_at).toLocaleDateString():this.$gettext("no")})).filter(s=>this.auth.can(s.type.toLowerCase()+":view"))}).catch(t=>{this.$log("ElementDetailRef::watch(item): Error fetching element",e,t)})}}}};function pe(e,t,i,n,m,s){return f(),$(A,null,{default:a(()=>[l(U,{class:"scroll"},{default:a(()=>[l(K,{modelValue:e.panel,"onUpdate:modelValue":t[0]||(t[0]=g=>e.panel=g),elevation:"0",multiple:""},{default:a(()=>{var g,u;return[(g=e.element.bypages)!=null&&g.length&&n.auth.can("page:view")?(f(),$(C,{key:0},{default:a(()=>[l(P,null,{default:a(()=>[v(d(e.$gettext("Shared elements")),1)]),_:1}),l(L,null,{default:a(()=>[l(N,{density:"comfortable",hover:""},{default:a(()=>[o("thead",null,[o("tr",null,[o("th",null,d(e.$gettext("ID")),1),o("th",null,d(e.$gettext("URL")),1),o("th",null,d(e.$gettext("Name")),1)])]),o("tbody",null,[(f(!0),c(w,null,O(e.element.bypages,h=>(f(),c("tr",{key:h.id},[o("td",null,d(h.id),1),o("td",null,d(h.path),1),o("td",null,d(h.name),1)]))),128))])]),_:1})]),_:1})]),_:1})):T("",!0),(u=e.versions)!=null&&u.length?(f(),$(C,{key:1},{default:a(()=>[l(P,null,{default:a(()=>t[1]||(t[1]=[v("Versions",-1)])),_:1,__:[1]}),l(L,null,{default:a(()=>[l(N,{density:"comfortable",hover:""},{default:a(()=>[o("thead",null,[o("tr",null,[o("th",null,d(e.$gettext("ID")),1),o("th",null,d(e.$gettext("Type")),1),o("th",null,d(e.$gettext("Published")),1)])]),o("tbody",null,[(f(!0),c(w,null,O(e.versions,h=>(f(),c("tr",{key:h.id},[o("td",null,d(h.id),1),o("td",null,d(h.type),1),o("td",null,d(h.published),1)]))),128))])]),_:1})]),_:1})]),_:1})):T("",!0)]}),_:1},8,["modelValue"])]),_:1})]),_:1})}const be=D(ge,[["render",pe],["__scopeId","data-v-381ac339"]]),ve={components:{Fields:he},props:{item:{type:Object,required:!0},assets:{type:Object,default:()=>{}}},emits:["update:item","error"],inject:["locales"],setup(){const e=Y(),t=Q(),i=X(),n=k();return{app:Z(),auth:n,languages:e,schemas:t,side:i}},computed:{readonly(){return!this.auth.can("element:save")}},methods:{fields(e){var t,i;return e?(t=this.schemas.content[e])!=null&&t.fields?(i=this.schemas.content[e])==null?void 0:i.fields:(console.warn(`No definition of fields for "${e}" schemas`),[]):[]},update(e,t){this.item[e]=t,this.$emit("update:item",this.item)}}};function ye(e,t,i,n,m,s){const g=b("Fields");return f(),$(A,null,{default:a(()=>[l(U,{class:"scroll"},{default:a(()=>[l(q,null,{default:a(()=>[l(I,{cols:"12",md:"6"},{default:a(()=>[l(x,{ref:"name",readonly:s.readonly,modelValue:i.item.name,"onUpdate:modelValue":t[0]||(t[0]=u=>s.update("name",u)),variant:"underlined",label:e.$gettext("Name"),counter:"255",maxlength:"255"},null,8,["readonly","modelValue","label"])]),_:1}),l(I,{cols:"12",md:"6"},{default:a(()=>[l(_,{ref:"lang",items:s.locales(!0),readonly:s.readonly,modelValue:i.item.lang,"onUpdate:modelValue":t[1]||(t[1]=u=>s.update("lang",u)),variant:"underlined",label:e.$gettext("Language")},null,8,["items","readonly","modelValue","label"])]),_:1})]),_:1}),l(q,null,{default:a(()=>[l(I,{cols:"12"},{default:a(()=>[l(g,{ref:"field",data:i.item.data,"onUpdate:data":t[2]||(t[2]=u=>i.item.data=u),files:i.item.files,"onUpdate:files":t[3]||(t[3]=u=>i.item.files=u),fields:s.fields(i.item.type),readonly:s.readonly,assets:i.assets,type:i.item.type,onError:t[4]||(t[4]=u=>e.$emit("error",u)),onChange:t[5]||(t[5]=u=>e.$emit("update:item",i.item))},null,8,["data","files","fields","readonly","assets","type"])]),_:1})]),_:1})]),_:1})]),_:1})}const ce=D(ve,[["render",ye]]),Ve={components:{AsideMeta:me,HistoryDialog:ue,ElementDetailRefs:be,ElementDetailItem:ce},inject:["closeView"],props:{item:{type:Object,required:!0}},data:()=>({assets:{},changed:!1,error:!1,publishAt:null,pubmenu:!1,vhistory:!1,tab:"element"}),setup(){const e=ee(),t=H();return{auth:k(),drawer:t,messages:e}},created(){var e;!((e=this.item)!=null&&e.id)||!this.auth.can("element:view")||this.$apollo.query({query:V`query($id: ID!) {
          element(id: $id) {
            id
            files {
              id
              mime
              name
              path
              previews
              updated_at
              editor
            }
            latest {
              id
              published
              data
              editor
              created_at
              files {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }
          }
        }`,variables:{id:this.item.id}}).then(t=>{var m;if(t.errors||!t.data.element)throw t;const i=[],n=t.data.element;this.reset(),this.assets={};for(const s of((m=n.latest)==null?void 0:m.files)||n.files||[])this.assets[s.id]={...s,previews:JSON.parse(s.previews||"{}")},i.push(s.id);this.item.files=i}).catch(t=>{this.messages.add(this.$gettext("Error fetching element"),"error"),this.$log("ElementDetail::watch(item): Error fetching element",t)})},methods:{publish(e=null){if(!this.auth.can("element:publish")){this.messages.add(this.$gettext("Permission denied"),"error");return}this.save(!0).then(t=>{var i,n;t&&this.$apollo.mutate({mutation:V`mutation ($id: [ID!]!, $at: DateTime) {
              pubElement(id: $id, at: $at) {
                id
              }
            }`,variables:{id:[this.item.id],at:(n=(i=e==null?void 0:e.toISOString())==null?void 0:i.substring(0,19))==null?void 0:n.replace("T"," ")}}).then(m=>{if(m.errors)throw m.errors;e?(this.item.publish_at=e,this.messages.add(this.$gettext("Element scheduled for publishing at %{date}",{date:e.toLocaleDateString()}),"info")):(this.item.published=!0,this.messages.add(this.$gettext("Element published successfully"),"success")),this.closeView()}).catch(m=>{this.messages.add(this.$gettext("Error publishing element"),"error"),this.$log("ElementDetail::publish(): Error publishing element",e,m)})})},reset(){this.changed=!1,this.error=!1},save(e=!1){return this.auth.can("element:save")?this.changed?this.$apollo.mutate({mutation:V`mutation ($id: ID!, $input: ElementInput!, $files: [ID!]) {
            saveElement(id: $id, input: $input, files: $files) {
              id
            }
          }`,variables:{id:this.item.id,input:{type:this.item.type,name:this.item.name,lang:this.item.lang,data:JSON.stringify(this.item.data||{})},files:this.item.files.filter((t,i,n)=>n.indexOf(t)===i)}}).then(t=>{if(t.errors)throw t.errors;return this.item.published=!1,this.reset(),e||this.messages.add(this.$gettext("Element saved successfully"),"success"),!0}).catch(t=>{this.messages.add(this.$gettext("Error saving element"),"error"),this.$log("ElementDetail::save(): Error saving element",t)}):Promise.resolve(!0):(this.messages.add(this.$gettext("Permission denied"),"error"),Promise.resolve(!1))},use(e){Object.assign(this.item,e.data),this.vhistory=!1,this.changed=!0},versions(e){return this.auth.can("element:view")?e?this.$apollo.query({query:V`query($id: ID!) {
            element(id: $id) {
              id
              versions {
                id
                published
                publish_at
                data
                editor
                created_at
                files {
                  id
                }
              }
            }
          }`,variables:{id:e}}).then(t=>{if(t.errors||!t.data.element)throw t;return(t.data.element.versions||[]).map(i=>({...i,data:JSON.parse(i.data||"{}"),files:i.files.map(n=>n.id)})).reverse()}).catch(t=>{this.messages.add(this.$gettext("Error fetching element versions"),"error"),this.$log("ElementDetail::versions(): Error fetching element versions",e,t)}):Promise.resolve([]):(this.messages.add(this.$gettext("Permission denied"),"error"),Promise.resolve([]))}}},$e={class:"app-title"},Ee={class:"menu-content"};function we(e,t,i,n,m,s){const g=b("ElementDetailItem"),u=b("ElementDetailRefs"),h=b("AsideMeta"),S=b("HistoryDialog");return f(),c(w,null,[l(R,{elevation:0,density:"compact"},{prepend:a(()=>[l(p,{onClick:t[0]||(t[0]=r=>s.closeView()),title:e.$gettext("Back to list view"),icon:"mdi-keyboard-backspace"},null,8,["title"])]),append:a(()=>[l(p,{onClick:t[1]||(t[1]=r=>e.vhistory=!0),class:E([{hidden:i.item.published&&!e.changed&&!i.item.latest},"no-rtl"]),title:e.$gettext("View history"),icon:"mdi-history"},null,8,["class","title"]),l(p,{onClick:t[2]||(t[2]=r=>s.save()),class:E([{error:e.error},"menu-save"]),disabled:!e.changed||e.error||!n.auth.can("element:save"),variant:"text"},{default:a(()=>[v(d(e.$gettext("Save")),1)]),_:1},8,["class","disabled"]),l(le,{modelValue:e.pubmenu,"onUpdate:modelValue":t[6]||(t[6]=r=>e.pubmenu=r),"close-on-content-click":!1},{activator:a(({props:r})=>[l(ae,{class:"menu-publish",variant:"text"},{default:a(()=>[l(p,{onClick:t[3]||(t[3]=y=>s.publish()),class:E([{error:e.error},"button"]),disabled:i.item.published&&!e.changed||e.error||!n.auth.can("element:publish")},{default:a(()=>[v(d(e.$gettext("Publish")),1)]),_:1},8,["class","disabled"]),l(p,se(r,{class:[{error:e.error},"icon"],disabled:i.item.published&&!e.changed||e.error||!n.auth.can("element:publish"),title:e.$gettext("Schedule publishing"),icon:"mdi-menu-down"}),null,16,["class","disabled","title"])]),_:2},1024)]),default:a(()=>[o("div",Ee,[l(ie,{modelValue:e.publishAt,"onUpdate:modelValue":t[4]||(t[4]=r=>e.publishAt=r),"hide-header":"","show-adjacent-months":""},null,8,["modelValue"]),l(p,{onClick:t[5]||(t[5]=r=>{s.publish(e.publishAt),e.pubmenu=!1}),disabled:!e.publishAt||e.error,color:e.publishAt?"primary":"",variant:"flat"},{default:a(()=>[v(d(e.$gettext("Publish")),1)]),_:1},8,["disabled","color"])])]),_:1},8,["modelValue"]),l(p,{onClick:t[7]||(t[7]=r=>n.drawer.toggle("aside")),title:e.$gettext("Toggle side menu"),icon:n.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"},null,8,["title","icon"])]),default:a(()=>[l(W,null,{default:a(()=>[o("div",$e,d(e.$gettext("Element"))+": "+d(i.item.name),1)]),_:1})]),_:1}),l(M,{class:"element-details"},{default:a(()=>[l(ne,{onSubmit:t[12]||(t[12]=re(()=>{},["prevent"]))},{default:a(()=>[l(de,{"fixed-tabs":"",modelValue:e.tab,"onUpdate:modelValue":t[8]||(t[8]=r=>e.tab=r)},{default:a(()=>[l(B,{value:"element",class:E({changed:e.changed,error:e.error})},{default:a(()=>[v(d(e.$gettext("Element")),1)]),_:1},8,["class"]),l(B,{value:"refs"},{default:a(()=>[v(d(e.$gettext("Used by")),1)]),_:1})]),_:1},8,["modelValue"]),l(oe,{modelValue:e.tab,"onUpdate:modelValue":t[11]||(t[11]=r=>e.tab=r)},{default:a(()=>[l(j,{value:"element"},{default:a(()=>[l(g,{"onUpdate:item":t[9]||(t[9]=r=>{this.$emit("update:item",i.item),e.changed=!0}),onError:t[10]||(t[10]=r=>e.error=r),assets:e.assets,item:i.item},null,8,["assets","item"])]),_:1}),l(j,{value:"refs"},{default:a(()=>[l(u,{item:i.item},null,8,["item"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(h,{item:i.item},null,8,["item"]),(f(),$(te,{to:"body"},[l(S,{modelValue:e.vhistory,"onUpdate:modelValue":t[13]||(t[13]=r=>e.vhistory=r),onUse:t[14]||(t[14]=r=>s.use(r)),onRevert:t[15]||(t[15]=r=>{s.use(r),s.reset()}),current:{data:{lang:i.item.lang,type:i.item.type,name:i.item.name,data:i.item.data},files:i.item.files},load:()=>s.versions(i.item.id)},null,8,["modelValue","current","load"])]))],64)}const F=D(Ve,[["render",we],["__scopeId","data-v-81a6592a"]]),De={components:{ElementListItems:fe,ElementDetail:F,Navigation:z,AsideList:G,User:J},inject:["locales","openView"],data:()=>({aside:null,filter:{trashed:"WITHOUT",publish:null,editor:null,lang:null}}),setup(){const e=H();return{auth:k(),drawer:e}},methods:{languages(){const e=[{title:this.$gettext("All"),icon:"mdi-playlist-check",value:{lang:null}}];for(const t of this.locales())e.push({title:t.title,icon:"mdi-translate",value:{lang:t.value}});return e},open(e){this.openView(F,{item:e})}}};function ke(e,t,i,n,m,s){var r;const g=b("User"),u=b("Navigation"),h=b("ElementListItems"),S=b("AsideList");return f(),c(w,null,[l(R,{elevation:0,density:"compact"},{prepend:a(()=>[l(p,{onClick:t[0]||(t[0]=y=>n.drawer.toggle("nav")),title:n.drawer.nav?e.$gettext("Close navigation"):e.$gettext("Open navigation"),icon:n.drawer.nav?"mdi-close":"mdi-menu"},null,8,["title","icon"])]),append:a(()=>[l(g),l(p,{onClick:t[1]||(t[1]=y=>n.drawer.toggle("aside")),title:e.$gettext("Toggle side menu"),icon:n.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"},null,8,["title","icon"])]),default:a(()=>[l(W,null,{default:a(()=>[v(d(e.$gettext("Shared elements")),1)]),_:1})]),_:1}),l(u),l(M,{class:"element-list"},{default:a(()=>[l(A,null,{default:a(()=>[l(U,{class:"box scroll"},{default:a(()=>[l(h,{filter:e.filter,onSelect:t[2]||(t[2]=y=>s.open(y))},null,8,["filter"])]),_:1})]),_:1})]),_:1}),l(S,{filter:e.filter,"onUpdate:filter":t[3]||(t[3]=y=>e.filter=y),content:[{key:"publish",title:e.$gettext("publish"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{publish:null}},{title:e.$gettext("Published"),icon:"mdi-publish",value:{publish:"PUBLISHED"}},{title:e.$gettext("Scheduled"),icon:"mdi-clock-outline",value:{publish:"SCHEDULED"}},{title:e.$gettext("Drafts"),icon:"mdi-pencil",value:{publish:"DRAFT"}}]},{key:"trashed",title:e.$gettext("trashed"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{trashed:"WITH"}},{title:e.$gettext("Available only"),icon:"mdi-delete-off",value:{trashed:"WITHOUT"}},{title:e.$gettext("Only trashed"),icon:"mdi-delete",value:{trashed:"ONLY"}}]},{key:"editor",title:e.$gettext("editor"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{editor:null}},{title:e.$gettext("Edited by me"),icon:"mdi-account",value:{editor:(r=this.auth.me)==null?void 0:r.email}}]},{key:"lang",title:e.$gettext("languages"),items:s.languages()}]},null,8,["filter","content"])],64)}const Te=D(De,[["render",ke],["__scopeId","data-v-371a973e"]]);export{Te as default};
