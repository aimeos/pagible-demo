import{U as Z,A as z,N as G}from"./Navigation-eoqzZlJ_.js";import{_ as D,K as V,a1 as k,b as w,w as i,ay as A,o as f,a,az as C,ac as Y,d as L,ad as U,ae as H,l as y,t as o,af as T,aA as P,f as d,c as v,F as E,a3 as N,aB as K,b6 as Q,aC as X,a2 as x,r as b,V as O,e as I,G as _,am as ee,a4 as te,aF as F,aG as R,aH as W,T as le,aI as J,h as p,n as $,j as ae,Y as ie,I as se,H as M,aJ as ne,i as re,a8 as de,a9 as q,aD as oe,aE as B}from"../index.js";import{H as ue,A as me}from"./utils-CgMtNAzL.js";import{F as he,E as fe}from"./ElementListItems-B_sfPort.js";const ge={props:{item:{type:Object,required:!0}},emits:[],data:()=>({panel:[0,1,2],versions:{},element:{}}),setup(){return{auth:k()}},watch:{item:{immediate:!0,handler(e){!e.id||!this.auth.can("element:view")||this.$apollo.query({query:V`query ($id: ID!) {
              element(id: $id) {
                id
                bypages {
                  id
                  path
                  name
                }
                byversions {
                  id
                  versionable_id
                  versionable_type
                  published
                  publish_at
                }
              }
            }`,variables:{id:e.id}}).then(t=>{var l,s,m;if(t.errors)throw t.errors;this.element=((l=t.data)==null?void 0:l.element)||{},this.versions=(((m=(s=t.data)==null?void 0:s.element)==null?void 0:m.byversions)||[]).map(n=>({id:n.versionable_id,type:n.versionable_type.split("\\").at(-1),published:n.published?this.$gettext("yes"):n.publish_at?new Date(n.publish_at).toLocaleDateString():this.$gettext("no")})).filter(n=>this.auth.can(n.type.toLowerCase()+":view"))}).catch(t=>{this.$log("ElementDetailRef::watch(item): Error fetching element",e,t)})}}}};function pe(e,t,l,s,m,n){return f(),w(A,null,{default:i(()=>[a(C,{class:"scroll"},{default:i(()=>[a(Y,{modelValue:e.panel,"onUpdate:modelValue":t[0]||(t[0]=g=>e.panel=g),elevation:"0",multiple:""},{default:i(()=>{var g,u;return[(g=e.element.bypages)!=null&&g.length&&s.auth.can("page:view")?(f(),w(U,{key:0},{default:i(()=>[a(H,null,{default:i(()=>[y(o(e.$gettext("Shared elements")),1)]),_:1}),a(T,null,{default:i(()=>[a(P,{density:"comfortable",hover:""},{default:i(()=>[d("thead",null,[d("tr",null,[d("th",null,o(e.$gettext("ID")),1),d("th",null,o(e.$gettext("URL")),1),d("th",null,o(e.$gettext("Name")),1)])]),d("tbody",null,[(f(!0),v(E,null,N(e.element.bypages,h=>(f(),v("tr",{key:h.id},[d("td",null,o(h.id),1),d("td",null,o(h.path),1),d("td",null,o(h.name),1)]))),128))])]),_:1})]),_:1})]),_:1})):L("",!0),(u=e.versions)!=null&&u.length?(f(),w(U,{key:1},{default:i(()=>[a(H,null,{default:i(()=>t[1]||(t[1]=[y("Versions",-1)])),_:1,__:[1]}),a(T,null,{default:i(()=>[a(P,{density:"comfortable",hover:""},{default:i(()=>[d("thead",null,[d("tr",null,[d("th",null,o(e.$gettext("ID")),1),d("th",null,o(e.$gettext("Type")),1),d("th",null,o(e.$gettext("Published")),1)])]),d("tbody",null,[(f(!0),v(E,null,N(e.versions,h=>(f(),v("tr",{key:h.id},[d("td",null,o(h.id),1),d("td",null,o(h.type),1),d("td",null,o(h.published),1)]))),128))])]),_:1})]),_:1})]),_:1})):L("",!0)]}),_:1},8,["modelValue"])]),_:1})]),_:1})}const be=D(ge,[["render",pe],["__scopeId","data-v-3187b449"]]),ve={components:{Fields:he},props:{item:{type:Object,required:!0},assets:{type:Object,default:()=>{}}},emits:["update:item","error"],inject:["locales"],setup(){const e=K(),t=Q(),l=X(),s=k();return{app:x(),auth:s,languages:e,schemas:t,side:l}},computed:{readonly(){return!this.auth.can("element:save")}},methods:{fields(e){var t,l;return e?(t=this.schemas.content[e])!=null&&t.fields?(l=this.schemas.content[e])==null?void 0:l.fields:(console.warn(`No definition of fields for "${e}" schemas`),[]):[]},update(e,t){this.item[e]=t,this.$emit("update:item",this.item)}}};function ye(e,t,l,s,m,n){const g=b("Fields");return f(),w(A,null,{default:i(()=>[a(C,{class:"scroll"},{default:i(()=>[a(O,null,{default:i(()=>[a(I,{cols:"12",md:"6"},{default:i(()=>[a(_,{ref:"name",readonly:n.readonly,modelValue:l.item.name,"onUpdate:modelValue":t[0]||(t[0]=u=>n.update("name",u)),variant:"underlined",label:e.$gettext("Name"),counter:"255",maxlength:"255"},null,8,["readonly","modelValue","label"])]),_:1}),a(I,{cols:"12",md:"6"},{default:i(()=>[a(ee,{ref:"lang",items:n.locales(!0),readonly:n.readonly,modelValue:l.item.lang,"onUpdate:modelValue":t[1]||(t[1]=u=>n.update("lang",u)),variant:"underlined",label:e.$gettext("Language")},null,8,["items","readonly","modelValue","label"])]),_:1})]),_:1}),a(O,null,{default:i(()=>[a(I,{cols:"12"},{default:i(()=>[a(g,{ref:"field",data:l.item.data,"onUpdate:data":t[2]||(t[2]=u=>l.item.data=u),files:l.item.files,"onUpdate:files":t[3]||(t[3]=u=>l.item.files=u),fields:n.fields(l.item.type),readonly:n.readonly,assets:l.assets,type:l.item.type,onError:t[4]||(t[4]=u=>e.$emit("error",u)),onChange:t[5]||(t[5]=u=>e.$emit("update:item",l.item))},null,8,["data","files","fields","readonly","assets","type"])]),_:1})]),_:1})]),_:1})]),_:1})}const ce=D(ve,[["render",ye],["__scopeId","data-v-5bdb6420"]]),Ve={components:{AsideMeta:me,HistoryDialog:ue,ElementDetailRefs:be,ElementDetailItem:ce},inject:["closeView"],props:{item:{type:Object,required:!0}},data:()=>({assets:{},changed:!1,error:!1,publishAt:null,pubmenu:!1,vhistory:!1,tab:"element"}),setup(){const e=te(),t=F();return{auth:k(),drawer:t,messages:e}},created(){var e;!((e=this.item)!=null&&e.id)||!this.auth.can("element:view")||this.$apollo.query({query:V`query($id: ID!) {
          element(id: $id) {
            id
            files {
              id
              mime
              name
              path
              previews
              updated_at
              editor
            }
            latest {
              id
              published
              data
              editor
              created_at
              files {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }
          }
        }`,variables:{id:this.item.id}}).then(t=>{var m;if(t.errors||!t.data.element)throw t;const l=[],s=t.data.element;this.reset(),this.assets={};for(const n of((m=s.latest)==null?void 0:m.files)||s.files||[])this.assets[n.id]={...n,previews:JSON.parse(n.previews||"{}")},l.push(n.id);this.item.files=l}).catch(t=>{this.messages.add(this.$gettext("Error fetching element"),"error"),this.$log("ElementDetail::watch(item): Error fetching element",t)})},methods:{publish(e=null){if(!this.auth.can("element:publish")){this.messages.add(this.$gettext("Permission denied"),"error");return}this.save(!0).then(t=>{var l,s;t&&this.$apollo.mutate({mutation:V`mutation ($id: [ID!]!, $at: DateTime) {
              pubElement(id: $id, at: $at) {
                id
              }
            }`,variables:{id:[this.item.id],at:(s=(l=e==null?void 0:e.toISOString())==null?void 0:l.substring(0,19))==null?void 0:s.replace("T"," ")}}).then(m=>{if(m.errors)throw m.errors;e?(this.item.publish_at=e,this.messages.add(this.$gettext("Element scheduled for publishing at %{date}",{date:e.toLocaleDateString()}),"info")):(this.item.published=!0,this.messages.add(this.$gettext("Element published successfully"),"success")),this.closeView()}).catch(m=>{this.messages.add(this.$gettext("Error publishing element"),"error"),this.$log("ElementDetail::publish(): Error publishing element",e,m)})})},reset(){this.changed=!1,this.error=!1},save(e=!1){return this.auth.can("element:save")?this.changed?this.$apollo.mutate({mutation:V`mutation ($id: ID!, $input: ElementInput!, $files: [ID!]) {
            saveElement(id: $id, input: $input, files: $files) {
              id
            }
          }`,variables:{id:this.item.id,input:{type:this.item.type,name:this.item.name,lang:this.item.lang,data:JSON.stringify(this.item.data||{})},files:this.item.files.filter((t,l,s)=>s.indexOf(t)===l)}}).then(t=>{if(t.errors)throw t.errors;return this.item.published=!1,this.reset(),e||this.messages.add(this.$gettext("Element saved successfully"),"success"),!0}).catch(t=>{this.messages.add(this.$gettext("Error saving element"),"error"),this.$log("ElementDetail::save(): Error saving element",t)}):Promise.resolve(!0):(this.messages.add(this.$gettext("Permission denied"),"error"),Promise.resolve(!1))},use(e){Object.assign(this.item,e.data),this.vhistory=!1,this.changed=!0},versions(e){return this.auth.can("element:view")?e?this.$apollo.query({query:V`query($id: ID!) {
            element(id: $id) {
              id
              versions {
                id
                published
                publish_at
                data
                editor
                created_at
                files {
                  id
                }
              }
            }
          }`,variables:{id:e}}).then(t=>{if(t.errors||!t.data.element)throw t;return(t.data.element.versions||[]).map(l=>({...l,data:JSON.parse(l.data||"{}"),files:l.files.map(s=>s.id)})).reverse()}).catch(t=>{this.messages.add(this.$gettext("Error fetching element versions"),"error"),this.$log("ElementDetail::versions(): Error fetching element versions",e,t)}):Promise.resolve([]):(this.messages.add(this.$gettext("Permission denied"),"error"),Promise.resolve([]))}}},we={class:"app-title"},$e={class:"menu-content"};function Ee(e,t,l,s,m,n){const g=b("ElementDetailItem"),u=b("ElementDetailRefs"),h=b("AsideMeta"),S=b("HistoryDialog");return f(),v(E,null,[a(R,{elevation:0,density:"compact"},{prepend:i(()=>[a(p,{onClick:t[0]||(t[0]=r=>n.closeView()),title:e.$gettext("Back to list view"),icon:"mdi-keyboard-backspace"},null,8,["title"])]),append:i(()=>[a(p,{onClick:t[1]||(t[1]=r=>e.vhistory=!0),class:$([{hidden:l.item.published&&!e.changed&&!l.item.latest},"no-rtl"]),title:e.$gettext("View history"),icon:"mdi-history"},null,8,["class","title"]),a(p,{onClick:t[2]||(t[2]=r=>n.save()),title:e.$gettext("Save"),class:$([{error:e.error},"menu-save"]),disabled:!e.changed||e.error||!s.auth.can("element:save"),variant:!e.changed||e.error||!s.auth.can("element:save")?"plain":"flat",color:!e.changed||e.error||!s.auth.can("element:save")?"":"blue-darken-1",icon:"mdi-database-arrow-down"},null,8,["title","class","disabled","variant","color"]),a(ae,{modelValue:e.pubmenu,"onUpdate:modelValue":t[5]||(t[5]=r=>e.pubmenu=r),"close-on-content-click":!1},{activator:i(({props:r})=>[a(p,se(r,{icon:"",title:e.$gettext("Schedule publishing"),class:[{error:e.error},"menu-publish"],disabled:l.item.published&&!e.changed||e.error||!s.auth.can("element:publish"),variant:l.item.published&&!e.changed||e.error||!s.auth.can("element:publish")?"plain":"flat",color:l.item.published&&!e.changed||e.error||!s.auth.can("element:publish")?"":"blue-darken-2"}),{default:i(()=>[a(M,null,{default:i(()=>t[16]||(t[16]=[d("svg",{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor"},[d("path",{d:"M2,1V3H16V1H2 M2,10H6V19H12V10H16L9,3L2,10Z"}),d("path",{d:"M16.7 11.4C16.7 11.4 16.61 11.4 16.7 11.4C13.19 11.49 10.4 14.28 10.4 17.7C10.4 21.21 13.19 24 16.7 24S23 21.21 23 17.7 20.21 11.4 16.7 11.4M16.7 22.2C14.18 22.2 12.2 20.22 12.2 17.7S14.18 13.2 16.7 13.2 21.2 15.18 21.2 17.7 19.22 22.2 16.7 22.2M15.6 13.1V17.6L18.84 19.58L19.56 18.5L16.95 16.97V13.1H15.6Z"})],-1)])),_:1,__:[16]})]),_:2},1040,["title","class","disabled","variant","color"])]),default:i(()=>[d("div",$e,[a(ie,{modelValue:e.publishAt,"onUpdate:modelValue":t[3]||(t[3]=r=>e.publishAt=r),"hide-header":"","show-adjacent-months":""},null,8,["modelValue"]),a(p,{onClick:t[4]||(t[4]=r=>{n.publish(e.publishAt),e.pubmenu=!1}),disabled:!e.publishAt||e.error,color:e.publishAt?"primary":"",variant:"flat"},{default:i(()=>[y(o(e.$gettext("Publish")),1)]),_:1},8,["disabled","color"])])]),_:1},8,["modelValue"]),a(p,{icon:"",onClick:t[6]||(t[6]=r=>n.publish()),title:e.$gettext("Publish"),class:$([{error:e.error},"menu-publish"]),disabled:l.item.published&&!e.changed||e.error||!s.auth.can("element:publish"),variant:l.item.published&&!e.changed||e.error||!s.auth.can("element:publish")?"plain":"flat",color:l.item.published&&!e.changed||e.error||!s.auth.can("element:publish")?"":"blue-darken-2"},{default:i(()=>[a(M,null,{default:i(()=>t[17]||(t[17]=[d("svg",{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",fill:"currentColor"},[d("path",{d:"M5,2V4H19V2H5 M5,12H9V21H15V12H19L12,5L5,12Z"})],-1)])),_:1,__:[17]})]),_:1},8,["title","class","disabled","variant","color"]),a(p,{onClick:t[7]||(t[7]=r=>s.drawer.toggle("aside")),title:e.$gettext("Toggle side menu"),icon:s.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"},null,8,["title","icon"])]),default:i(()=>[a(J,null,{default:i(()=>[d("div",we,o(e.$gettext("Element"))+": "+o(l.item.name),1)]),_:1})]),_:1}),a(W,{class:"element-details"},{default:i(()=>[a(ne,{onSubmit:t[12]||(t[12]=re(()=>{},["prevent"]))},{default:i(()=>[a(de,{"fixed-tabs":"",modelValue:e.tab,"onUpdate:modelValue":t[8]||(t[8]=r=>e.tab=r)},{default:i(()=>[a(q,{value:"element",class:$({changed:e.changed,error:e.error})},{default:i(()=>[y(o(e.$gettext("Element")),1)]),_:1},8,["class"]),a(q,{value:"refs"},{default:i(()=>[y(o(e.$gettext("Used by")),1)]),_:1})]),_:1},8,["modelValue"]),a(oe,{modelValue:e.tab,"onUpdate:modelValue":t[11]||(t[11]=r=>e.tab=r),touch:!1},{default:i(()=>[a(B,{value:"element"},{default:i(()=>[a(g,{"onUpdate:item":t[9]||(t[9]=r=>{this.$emit("update:item",l.item),e.changed=!0}),onError:t[10]||(t[10]=r=>e.error=r),assets:e.assets,item:l.item},null,8,["assets","item"])]),_:1}),a(B,{value:"refs"},{default:i(()=>[a(u,{item:l.item},null,8,["item"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(h,{item:l.item},null,8,["item"]),(f(),w(le,{to:"body"},[a(S,{modelValue:e.vhistory,"onUpdate:modelValue":t[13]||(t[13]=r=>e.vhistory=r),onUse:t[14]||(t[14]=r=>n.use(r)),onRevert:t[15]||(t[15]=r=>{n.use(r),n.reset()}),current:{data:{lang:l.item.lang,type:l.item.type,name:l.item.name,data:l.item.data},files:l.item.files},load:()=>n.versions(l.item.id)},null,8,["modelValue","current","load"])]))],64)}const j=D(Ve,[["render",Ee],["__scopeId","data-v-b85d43cc"]]),De={components:{ElementListItems:fe,ElementDetail:j,Navigation:G,AsideList:z,User:Z},inject:["locales","openView"],data:()=>({aside:null,filter:{trashed:"WITHOUT",publish:null,editor:null,lang:null}}),setup(){const e=F();return{auth:k(),drawer:e}},methods:{languages(){const e=[{title:this.$gettext("All"),icon:"mdi-playlist-check",value:{lang:null}}];for(const t of this.locales())e.push({title:t.title,icon:"mdi-translate",value:{lang:t.value}});return e},open(e){this.openView(j,{item:e})}}};function ke(e,t,l,s,m,n){var r;const g=b("User"),u=b("Navigation"),h=b("ElementListItems"),S=b("AsideList");return f(),v(E,null,[a(R,{elevation:0,density:"compact"},{prepend:i(()=>[a(p,{onClick:t[0]||(t[0]=c=>s.drawer.toggle("nav")),title:s.drawer.nav?e.$gettext("Close navigation"):e.$gettext("Open navigation"),icon:s.drawer.nav?"mdi-close":"mdi-menu"},null,8,["title","icon"])]),append:i(()=>[a(g),a(p,{onClick:t[1]||(t[1]=c=>s.drawer.toggle("aside")),title:e.$gettext("Toggle side menu"),icon:s.drawer.aside?"mdi-chevron-right":"mdi-chevron-left"},null,8,["title","icon"])]),default:i(()=>[a(J,null,{default:i(()=>[y(o(e.$gettext("Shared elements")),1)]),_:1})]),_:1}),a(u),a(W,{class:"element-list"},{default:i(()=>[a(A,null,{default:i(()=>[a(C,{class:"box scroll"},{default:i(()=>[a(h,{filter:e.filter,onSelect:t[2]||(t[2]=c=>n.open(c))},null,8,["filter"])]),_:1})]),_:1})]),_:1}),a(S,{filter:e.filter,"onUpdate:filter":t[3]||(t[3]=c=>e.filter=c),content:[{key:"publish",title:e.$gettext("publish"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{publish:null}},{title:e.$gettext("Published"),icon:"mdi-publish",value:{publish:"PUBLISHED"}},{title:e.$gettext("Scheduled"),icon:"mdi-clock-outline",value:{publish:"SCHEDULED"}},{title:e.$gettext("Drafts"),icon:"mdi-pencil",value:{publish:"DRAFT"}}]},{key:"trashed",title:e.$gettext("trashed"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{trashed:"WITH"}},{title:e.$gettext("Available only"),icon:"mdi-delete-off",value:{trashed:"WITHOUT"}},{title:e.$gettext("Only trashed"),icon:"mdi-delete",value:{trashed:"ONLY"}}]},{key:"editor",title:e.$gettext("editor"),items:[{title:e.$gettext("All"),icon:"mdi-playlist-check",value:{editor:null}},{title:e.$gettext("Edited by me"),icon:"mdi-account",value:{editor:(r=this.auth.me)==null?void 0:r.email}}]},{key:"lang",title:e.$gettext("languages"),items:n.languages()}]},null,8,["filter","content"])],64)}const Le=D(De,[["render",ke],["__scopeId","data-v-371a973e"]]);export{Le as default};
