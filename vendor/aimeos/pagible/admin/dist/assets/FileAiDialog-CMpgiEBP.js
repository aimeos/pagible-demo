import{_ as V,L as g,a5 as x,a3 as $,b as c,w as l,a6 as y,o as d,a as s,a7 as C,a8 as k,c as f,d as w,a0 as F,k as u,l as p,t as m,a9 as S,aa as _,i as B,F as L,a4 as O,j as U,f as b}from"../index.js";import{F as A}from"./FileListItems-BHj5RakU.js";const j={components:{FileListItems:A},props:{modelValue:{type:Boolean,required:!0},context:{type:[Object,null],default:null}},emits:["update:modelValue","add"],inject:["slugify","url"],setup(){const e=x();return{app:$(),messages:e}},data(){return{input:"",items:[],errors:[],similar:[],loading:!1}},beforeUpdate(){var e,t,a;this.input=[(e=this.context)==null?void 0:e.title,(t=this.context)==null?void 0:t.text,(a=this.context)==null?void 0:a.description].filter(Boolean).join(`
`)},unmounted(){this.items.forEach(e=>{e.path.startsWith("blob:")&&URL.revokeObjectURL(e.path)}),this.similar=[],this.items=[]},methods:{add(e){if(!e.path.startsWith("blob:")){this.$emit("add",[e]);return}this.loading=!0,fetch(e.path).then(t=>t.blob()).then(t=>{const a=this.slugify(e.name)+"_"+new Date().toISOString().replace(/[^0-9]/g,"")+".png";return this.$apollo.mutate({mutation:g`mutation($input: FileInput, $file: Upload) {
              addFile(input: $input, file: $file) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{name:e.name},file:new File([t],a,{type:e.mime})},context:{hasUpload:!0}})}).then(t=>{if(t.errors)throw t.errors;Object.assign(e,t.data.addFile,{previews:JSON.parse(t.data.addFile.previews||"{}")}),this.$emit("add",[e])}).catch(t=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:e==null?void 0:e.path}),"error"),this.$log("FileAiDialog::add(): Error adding file",t)}).finally(()=>{this.loading=!1})},base64ToBlob(e,t="image/png"){if(!e)return null;const a=atob(e),r=new Uint8Array(a.length);for(let i=0;i<a.length;i++)r[i]=a.charCodeAt(i);return new Blob([r],{type:t})},create(){!this.input||this.loading||(this.loading=!0,this.original=this.input,this.$apollo.mutate({mutation:g`mutation($prompt: String!, $context: String, $files: [String!]) {
            imagine(prompt: $prompt, context: $context, files: $files)
          }`,variables:{prompt:`Create as suitable image for:
`+this.input,context:this.context?`Context in JSON format:
`+JSON.stringify(this.context):"",files:this.similar.map(e=>e.path)}}).then(e=>{if(e.errors)throw e.errors;const t=this.input,a=e.data.imagine;this.input=a.shift()||this.input,a.forEach(r=>{this.items.unshift({path:URL.createObjectURL(this.base64ToBlob(r)),name:t.slice(0,t.length>100?t.lastIndexOf(" ",100):100),mime:"image/png"})})}).catch(e=>{this.messages.add(this.$gettext("Error creating file"),"error"),this.$log("FileAiDialog::create(): Error creating file",e)}).finally(()=>{this.loading=!1}))},remove(e){this.items.splice(e,1)},removeSimilar(e){this.similar.splice(e,1)},use(e){this.similar.find(t=>t.path===e.path)||this.similar.push(e)}}},D={key:0},E=["onClick"],N=["src"];function T(e,t,a,r,i,o){return d(),c(y,{modelValue:a.modelValue,onAfterLeave:t[3]||(t[3]=n=>e.$emit("update:modelValue",!1)),"max-width":"1200",scrollable:""},{default:l(()=>[s(C,{loading:i.loading?"primary":!1},{append:l(()=>[s(u,{onClick:t[0]||(t[0]=n=>e.$emit("update:modelValue",!1)),title:e.$gettext("Close"),icon:"mdi-close",variant:"text",elevation:"0"},null,8,["title"])]),title:l(()=>[p(m(e.$gettext("Create image")),1)]),default:l(()=>[s(k,null,{default:l(()=>[s(F,{modelValue:i.input,"onUpdate:modelValue":t[1]||(t[1]=n=>i.input=n),label:e.$gettext("Describe the image"),variant:"underlined",autofocus:"",clearable:""},null,8,["modelValue","label"]),s(u,{loading:i.loading?"primary":!1,disabled:!i.input||i.loading,onClick:t[2]||(t[2]=n=>o.create()),variant:"outlined",class:"create"},{default:l(()=>[p(m(e.$gettext("Create image")),1)]),_:1},8,["loading","disabled"]),i.items.length?(d(),f("div",D,[s(S,null,{default:l(()=>[s(_,null,{default:l(()=>[p(m(e.$gettext("Generated images")),1)]),_:1})]),_:1}),s(B,{class:"items grid"},{default:l(()=>[(d(!0),f(L,null,O(i.items,(n,h)=>(d(),c(U,{key:h},{default:l(()=>[s(u,{onClick:v=>o.remove(h),title:e.$gettext("Remove"),class:"btn-overlay",icon:"mdi-delete"},null,8,["onClick","title"]),b("div",{class:"item-preview",onClick:v=>o.add(n)},[b("img",{src:o.url(n.path)},null,8,N)],8,E)]),_:2},1024))),128))]),_:1})])):w("",!0)]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const J=V(j,[["render",T],["__scopeId","data-v-72cb1245"]]);export{J as F};
