import{_ as C,K as w,a4 as B,a2 as L,b as f,w as a,a5 as F,o,a as d,a6 as x,a7 as b,$ as E,aw as y,G as I,aa as U,c,F as _,a3 as A,ab as D,f as u,h as v,t as p,l as V,d as S,r as T,ax as z}from"../index.js";import{F as O}from"./FileListItems-CVuZQHeb.js";const R={props:{modelValue:{type:Boolean,required:!0},multiple:{type:Boolean,required:!1},mime:{type:String,default:""}},emits:["update:modelValue","add"],setup(){const t=B();return{app:L(),messages:t}},data(){return{errors:[],input:"",items:{},loading:!1}},methods:{add(){const t=[],e=Object.values(this.items);e.length&&(this.loading=!0,e.forEach(s=>{t.push(this.$apollo.mutate({mutation:w`mutation($input: FileInput) {
              addFile(input: $input) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{path:s.path,name:s.name}}}).then(n=>{if(n.errors)throw n.errors;Object.assign(s,n.data.addFile,{previews:JSON.parse(n.data.addFile.previews||"{}")})}).catch(n=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:s.path}),"error"),this.$log("FileUrlDialog::add(): Error adding file",s,n)}).finally(()=>{this.loading=!1}))}),Promise.all(t).then(()=>{this.$emit("update:modelValue",!1),this.$emit("add",e),this.input="",this.items={}}))},remove(t){delete this.items[t]},size(t){return t?t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(2)} KB`:t<1024*1024*1024?`${(t/(1024*1024)).toFixed(2)} MB`:`${(t/(1024*1024*1024)).toFixed(2)} GB`:""},update(){const t=this.input.split(`
`).map(e=>e.trim()).filter(e=>e&&e.startsWith("http"));for(const e of t)if((e==null?void 0:e.length)>255){this.errors=[this.$gettext("At least one URL is longer than 255 characters")];return}for(const e of Object.keys(this.items))t.includes(e)||delete this.items[e];t.forEach(e=>{this.items[e]||fetch(this.app.urlproxy.replace("_url_",encodeURIComponent(e)),{credentials:"include",method:"HEAD"}).then(s=>{var n,l,r,i,m,h,g;if(!s.ok)throw new Error(`Failed to fetch ${e}`,s);(l=(n=s.headers)==null?void 0:n.get("Content-Type"))!=null&&l.startsWith(this.mime)?this.items[e]={path:e,mime:(r=s.headers)==null?void 0:r.get("Content-Type"),size:parseInt((i=s.headers)==null?void 0:i.get("Content-Length")),name:(((g=(h=(m=e.split("?"))==null?void 0:m.shift())==null?void 0:h.split("/"))==null?void 0:g.pop())||e).slice(0,100)}:this.errors=this.multiple?[this.$gettext('At least one file is not of type "%{mime}*"',{mime:this.mime})]:[this.$gettext('The file is not of type "%{mime}*"',{mime:this.mime})]}).catch(s=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:e}),"error"),this.$log(`FileUrlDialog::update(): Error fetching ${e}`,s)})})}}},j=["onClick"],K=["src"],N=["src"],W=["src"],q=["href"],G=["onClick"],M={class:"item-text"},H={class:"item-title"},J={class:"item-mime item-subtitle"},P={class:"item-aux"},Q={class:"item-size"};function X(t,e,s,n,l,r){return o(),f(F,{modelValue:s.modelValue,onAfterLeave:e[10]||(e[10]=i=>t.$emit("update:modelValue",!1)),"max-width":"1200",scrollable:""},{default:a(()=>[d(x,{loading:l.loading?"primary":!1},{append:a(()=>[Object.keys(l.items).length?(o(),f(v,{key:0,variant:"outlined",onClick:e[0]||(e[0]=i=>r.add())},{default:a(()=>[V(p(s.multiple?t.$gettext("Add files"):t.$gettext("Add file")),1)]),_:1})):S("",!0),d(v,{onClick:e[1]||(e[1]=i=>t.$emit("update:modelValue",!1)),title:t.$gettext("Close"),icon:"mdi-close",variant:"flat"},null,8,["title"])]),title:a(()=>[V(p(t.$gettext("Add files from URLs")),1)]),default:a(()=>[d(b,null,{default:a(()=>[s.multiple?(o(),f(E,{key:0,ref:"input",modelValue:l.input,"onUpdate:modelValue":e[2]||(e[2]=i=>l.input=i),onKeyup:e[3]||(e[3]=y(i=>r.update(),["enter"])),"onClick:appendInner":e[4]||(e[4]=i=>r.update()),"onClick:clear":e[5]||(e[5]=i=>l.errors=[]),"error-messages":l.errors,"append-inner-icon":l.input?"mdi-check":"",placeholder:t.$gettext("Enter one URL per line"),variant:"outlined",autofocus:"","auto-grow":"",clearable:"",rows:"3"},null,8,["modelValue","error-messages","append-inner-icon","placeholder"])):(o(),f(I,{key:1,ref:"input",modelValue:l.input,"onUpdate:modelValue":e[6]||(e[6]=i=>l.input=i),onKeyup:e[7]||(e[7]=y(i=>r.update(),["enter"])),"onClick:appendInner":e[8]||(e[8]=i=>r.update()),"onClick:clear":e[9]||(e[9]=i=>l.errors=[]),"error-messages":l.errors,"append-inner-icon":l.input?"mdi-check":"",placeholder:t.$gettext("Enter URL"),variant:"outlined",maxlength:"255",counter:"255",autofocus:"",clearable:""},null,8,["modelValue","error-messages","append-inner-icon","placeholder"])),d(U,{class:"items grid"},{default:a(()=>[(o(!0),c(_,null,A(l.items,(i,m)=>(o(),f(D,{key:m},{default:a(()=>{var h,g,$;return[d(v,{onClick:k=>r.remove(m),title:t.$gettext("Remove file"),class:"btn-overlay",icon:"mdi-delete"},null,8,["onClick","title"]),u("div",{class:"item-preview",onClick:k=>t.$emit("select",i)},[(h=i.mime)!=null&&h.startsWith("image/")?(o(),c("img",{key:0,src:i.path},null,8,K)):(g=i.mime)!=null&&g.startsWith("video/")?(o(),c("video",{key:1,preload:"metadata",controls:"",src:i.path},null,8,N)):($=i.mime)!=null&&$.startsWith("audio/")?(o(),c("audio",{key:2,preload:"metadata",controls:"",src:i.path},null,8,W)):(o(),c("a",{key:3,href:i.path,target:"_blank"},p(i.path),9,q))],8,j),u("div",{class:"item-content",onClick:k=>t.$emit("select",i)},[u("div",M,[u("span",H,p(i.name),1),u("div",J,p(i.mime),1)]),u("div",P,[u("div",Q,"Size: "+p(r.size(i.size)),1)])],8,G)]}),_:2},1024))),128))]),_:1})]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const ie=C(R,[["render",X],["__scopeId","data-v-432a3921"]]),Y={components:{FileListItems:O},props:{modelValue:{type:Boolean,required:!0},filter:{type:Object,default:()=>({})},grid:{type:Boolean,default:!1}},emits:["update:modelValue","add"]};function Z(t,e,s,n,l,r){const i=T("FileListItems");return o(),f(F,{modelValue:s.modelValue,onAfterLeave:e[2]||(e[2]=m=>t.$emit("update:modelValue",!1)),"max-width":"1200",scrollable:""},{default:a(()=>[d(x,null,{append:a(()=>[d(v,{onClick:e[0]||(e[0]=m=>t.$emit("update:modelValue",!1)),title:t.$gettext("Close"),icon:"mdi-close",variant:"flat"},null,8,["title"])]),title:a(()=>[V(p(t.$gettext("Files")),1)]),default:a(()=>[d(z),d(b,null,{default:a(()=>[d(i,{filter:s.filter,grid:s.grid,onSelect:e[1]||(e[1]=m=>t.$emit("add",m)),embed:""},null,8,["filter","grid"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}const se=C(Y,[["render",Z]]);export{ie as F,se as a};
