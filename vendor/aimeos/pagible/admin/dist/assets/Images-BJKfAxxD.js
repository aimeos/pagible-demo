import{_ as A,c as h,a as n,b as m,w as F,r as v,T as y,F as b,K as D,a1 as C,a2 as x,o,d as g,a3 as L,n as j,g as O,a0 as R,h as p,i as I,f as k,j as B}from"../index.js";import{l as E}from"./vue-draggable-plus-D1RNgL6u.js";import{F as N}from"./FileAiDialog-CCnHbO9L.js";import{F as P,a as U}from"./FileListItems-MigusJ7k.js";import{F as M,a as S}from"./FileDialog-DgBVR8x_.js";import"./utils-DxnQAr0v.js";const T={components:{FileDetail:U,FileDialog:S,FileAiDialog:N,FileUrlDialog:M,FileListItems:P,VueDraggable:E},inject:["openView","url","srcset"],props:{modelValue:{type:Array,default:()=>[]},config:{type:Object,default:()=>{}},assets:{type:Object,default:()=>{}},readonly:{type:Boolean,default:!1},context:{type:Object}},emits:["update:modelValue","error","addFile","removeFile"],setup(){const t=C();return{app:x(),auth:t}},data(){return{images:[],index:Math.floor(Math.random()*1e5),selected:null,vcreate:!1,vfiles:!1,vurls:!1}},unmounted(){this.images.forEach(t=>{var e;(e=t.path)!=null&&e.startsWith("blob:")&&URL.revokeObjectURL(t.path)})},methods:{add(t){if(!this.auth.can("file:add")){this.messages.add(this.$gettext("Permission denied"),"error");return}const e=[];t!=null&&t.length&&(Array.from(t).forEach(a=>{const c=URL.createObjectURL(a),l=this.images.length;this.images[l]={path:c,uploading:!0};const s=this.$apollo.mutate({mutation:D`mutation($file: Upload!) {
              addFile(file: $file) {
                id
                mime
                name
                path
                previews
              }
            }`,variables:{file:a},context:{hasUpload:!0}}).then(d=>{var f;if(d.errors)throw d.errors;const r=((f=d.data)==null?void 0:f.addFile)||{};return r.previews=JSON.parse(r.previews)||{},delete r.__typename,new Promise((V,i)=>{const u=new Image;u.onload=V,u.onerror=i,u.src=this.url(Object.values(r.previews)[0])}).then(()=>{this.images[l]=r,this.$emit("addFile",r),URL.revokeObjectURL(c)})}).catch(d=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:a.name}),"error"),this.$log("Images::addFile(): Error adding file",ev,d)});e.push(s)}),Promise.all(e).then(()=>{this.$emit("update:modelValue",this.images.map(a=>({id:a.id,type:"file"})))}),this.selected=null)},change(){this.$emit("update:modelValue",this.images.map(t=>({id:t.id,type:"file"})))},open(t){this.openView(U,{item:t})},remove(t){var e;(e=this.images[t])!=null&&e.id&&this.$emit("removeFile",this.images[t].id),this.images.splice(t,1),this.$emit("update:modelValue",this.images.map(a=>({id:a.id,type:"file"}))),this.validate()},select(t){Array.isArray(t)||(t=[t]),t.forEach(e=>{this.images.push(e),this.$emit("addFile",e)}),this.$emit("update:modelValue",this.images.map(e=>({id:e.id,type:"file"}))),this.vfiles=!1,this.vurls=!1,this.validate()},async validate(){const t=this.images.length>=(this.config.min??0)&&this.images.length<=(this.config.max??1e3);return this.$emit("error",!t),await t}},watch:{modelValue:{immediate:!0,handler(t){if(!this.images.length)for(const e of t||[])this.assets[e.id]&&this.images.push(this.assets[e.id])}}}},q=["onClick"],z={key:0,class:"add"},J={class:"icon-group"},K={class:"icon-group"};function W(t,e,a,c,l,s){const d=v("VueDraggable"),r=v("FileDialog"),f=v("FileAiDialog"),V=v("FileUrlDialog");return o(),h(b,null,[n(d,{modelValue:l.images,"onUpdate:modelValue":e[5]||(e[5]=i=>l.images=i),disabled:a.readonly,onUpdate:e[6]||(e[6]=i=>s.change()),draggable:".image",group:"images",class:"images",animation:"500"},{default:F(()=>[(o(!0),h(b,null,L(l.images,(i,u)=>(o(),h("div",{key:u,class:j([{readonly:a.readonly},"image"]),onClick:w=>s.open(i)},[i.uploading?(o(),m(O,{key:0,color:"primary",height:"5",indeterminate:"",rounded:""})):g("",!0),i.path?(o(),m(R,{key:1,srcset:s.srcset(i.previews),src:s.url(i.path),draggable:"false"},null,8,["srcset","src"])):g("",!0),!a.readonly&&i.id?(o(),m(p,{key:2,onClick:I(w=>s.remove(u),["stop"]),title:t.$gettext("Remove file"),icon:"mdi-trash-can",class:"btn-overlay",variant:"flat"},null,8,["onClick","title"])):g("",!0)],10,q))),128)),a.readonly?g("",!0):(o(),h("div",z,[k("div",J,[c.auth.can("file:view")?(o(),m(p,{key:0,onClick:e[0]||(e[0]=i=>l.vfiles=!0),title:t.$gettext("Add files"),icon:"mdi-button-cursor",variant:"flat"},null,8,["title"])):g("",!0),n(p,{onClick:e[1]||(e[1]=i=>l.vurls=!0),title:t.$gettext("Add files from URLs"),icon:"mdi-link-variant-plus",variant:"flat"},null,8,["title"])]),k("div",K,[n(p,{onClick:e[2]||(e[2]=i=>l.vcreate=!0),title:t.$gettext("Create file"),icon:"mdi-creation",variant:"flat"},null,8,["title"]),n(p,{title:t.$gettext("Add files"),icon:"mdi-upload",variant:"flat"},{default:F(()=>[n(B,{modelValue:l.selected,"onUpdate:modelValue":[e[3]||(e[3]=i=>l.selected=i),e[4]||(e[4]=i=>s.add(i))],accept:a.config.accept||"image/*","hide-input":!0,"prepend-icon":"mdi-upload",multiple:""},null,8,["modelValue","accept"])]),_:1},8,["title"])])]))]),_:1},8,["modelValue","disabled"]),(o(),m(y,{to:"body"},[n(r,{modelValue:l.vfiles,"onUpdate:modelValue":e[7]||(e[7]=i=>l.vfiles=i),onAdd:e[8]||(e[8]=i=>s.select(i)),filter:{mime:"image/"},grid:""},null,8,["modelValue"])])),(o(),m(y,{to:"body"},[n(f,{modelValue:l.vcreate,"onUpdate:modelValue":e[9]||(e[9]=i=>l.vcreate=i),onAdd:e[10]||(e[10]=i=>{s.select(i),l.vcreate=!1}),context:a.context},null,8,["modelValue","context"])])),(o(),m(y,{to:"body"},[n(V,{modelValue:l.vurls,"onUpdate:modelValue":e[11]||(e[11]=i=>l.vurls=i),onAdd:e[12]||(e[12]=i=>s.select(i)),mime:"image/",multiple:""},null,8,["modelValue"])]))],64)}const _=A(T,[["render",W],["__scopeId","data-v-e23cac70"]]);export{_ as default};
