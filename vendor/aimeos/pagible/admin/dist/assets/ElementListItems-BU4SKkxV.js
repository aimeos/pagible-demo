import{_ as D,a4 as N,c as k,a3 as y,F as x,o as u,n as T,b,d as _,w as l,k as p,t as h,a as i,I as w,aa as I,ab as g,h as c,H as S,ag as A,ah as U,b7 as j,a8 as B,bh as q,a9 as M,bi as R,a6 as J,f,K as $,a1 as H,i as W,aL as F,E as z,aM as G,a5 as Q,T as Y,r as K,aN as V,aO as E,G as X}from"../index.js";import"./utils-DxnQAr0v.js";const Z={props:{data:{type:Object,default:()=>{}},files:{type:Array,default:()=>[]},assets:{type:Object,default:()=>{}},readonly:{type:Boolean,default:!1},fields:{type:Object,required:!0},type:{type:String,default:""}},emits:["change","error","update:files"],inject:["compose","translate","txlocales"],data(){return{translating:{},composing:{},errors:{}}},setup(){return{messages:N()}},methods:{addFile(e){if(!(e!=null&&e.id)){this.$log("Fields::addFile(): Invalid item without ID",e);return}const t=[...this.files];t.push(e.id),this.assets[e.id]=e,this.$emit("update:files",t)},composeText(e){const t=['generate for field "'+(this.fields[e].label||e)+'"','required output format is "'+this.fields[e].type+'"',this.fields[e].min?"minimum characters: "+this.fields[e].min:null,this.fields[e].max?"maximum characters: "+this.fields[e].max:null,this.fields[e].placeholder?"hint text: "+this.fields[e].placeholder:null,"context information as JSON: "+JSON.stringify(this.data)];this.composing[e]=!0,this.compose(this.data[e]??"",t).then(a=>{this.update(e,a)}).finally(()=>{this.composing[e]=!1})},error(e,t){this.errors[e]=t,this.$emit("error",Object.values(this.errors).includes(!0))},removeFile(e){if(!e){this.$log("Fields::removeFile(): Invalid ID",e);return}const t=[...this.files],a=t.findIndex(o=>o===e);a!==-1&&t.splice(a,1),this.$emit("update:files",t)},toName(e){var t;return((t=e==null?void 0:e.charAt(0))==null?void 0:t.toUpperCase())+(e==null?void 0:e.slice(1))},translateText(e,t){this.translating[e]=!0,this.translate([this.data[e]],t).then(a=>{this.update(e,a[0]||"")}).finally(()=>{this.translating[e]=!1})},update(e,t){this.data[e]=t,this.$emit("change",this.data[e])},validate(){var t;const e=[];return this.errors={},(t=this.$refs.field)==null||t.forEach(a=>{e.push(a.validate())}),Promise.all(e).then(a=>a.every(o=>o))}}},ee={key:0,class:"actions"};function te(e,t,a,o,r,n){return u(!0),k(x,null,y(a.fields,(d,s)=>(u(),k("div",{key:s,class:T(["item",{error:r.errors[s]}])},[d.type!=="hidden"?(u(),b(A,{key:0},{default:l(()=>[p(h(e.$pgettext("fn",d.label||s).replace(/-/g," "))+" ",1),!a.readonly&&["markdown","plaintext","string","text"].includes(d.type)?(u(),k("div",ee,[i(w,null,{activator:l(({props:m})=>[i(c,S({ref_for:!0},m,{title:e.$gettext("Translate %{code} field",{code:s}),loading:r.translating[s],icon:"mdi-translate",variant:"flat"}),null,16,["title","loading"])]),default:l(()=>[i(I,null,{default:l(()=>[(u(!0),k(x,null,y(n.txlocales(),m=>(u(),b(g,{key:m.code},{default:l(()=>[i(c,{onClick:v=>n.translateText(s,m.code),"prepend-icon":"mdi-arrow-right-thin",variant:"text"},{default:l(()=>[p(h(m.name),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:2},1024)]),_:2},1024),i(c,{title:e.$gettext("Generate text for %{code} field",{code:s}),loading:r.composing[s],onClick:m=>n.composeText(s),icon:"mdi-creation",variant:"flat"},null,8,["title","loading","onClick"])])):_("",!0)]),_:2},1024)):_("",!0),(u(),b(U(n.toName(d.type)),{ref_for:!0,ref:"field",key:d.type+"-"+s,context:a.data,assets:a.assets,config:d,readonly:a.readonly,modelValue:a.data[s],onAddFile:t[0]||(t[0]=m=>n.addFile(m)),onRemoveFile:t[1]||(t[1]=m=>n.removeFile(m)),"onUpdate:modelValue":m=>n.update(s,m),onError:m=>n.error(s,m)},null,40,["context","assets","config","readonly","modelValue","onUpdate:modelValue","onError"]))],2))),128)}const Ee=D(Z,[["render",te],["__scopeId","data-v-6f3d75bf"]]),se={props:{type:{type:String,required:!0}},emits:["add"],data:()=>({tab:["basic"]}),setup(){return{schemas:j()}},computed:{groups(){const e={};for(const t in this.schemas[this.type]||{}){const a=this.schemas[this.type][t],o=a.group||this.$gettext("uncategorized");a.type=t,e[o]=e[o]||[],e[o].push(a)}return e}},methods:{add(e){this.$emit("add",{type:e.type})}}},ae=["innerHTML"];function le(e,t,a,o,r,n){return u(),k(x,null,[i(B,{modelValue:e.tab,"onUpdate:modelValue":t[0]||(t[0]=d=>e.tab=d)},{default:l(()=>[(u(!0),k(x,null,y(n.groups,(d,s)=>(u(),b(M,{key:s,value:s},{default:l(()=>[p(h(e.$pgettext("sg",s)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"]),i(q,{modelValue:e.tab,"onUpdate:modelValue":t[1]||(t[1]=d=>e.tab=d)},{default:l(()=>[(u(!0),k(x,null,y(Object.keys(n.groups),d=>(u(),b(R,{key:d,value:d},{default:l(()=>[i(J,null,{default:l(()=>[(u(!0),k(x,null,y(n.groups[d],s=>(u(),b(c,{key:s.type,onClick:m=>n.add(s),variant:"text",stacked:""},{prepend:l(()=>[f("span",{class:"icon",innerHTML:s.icon},null,8,ae)]),default:l(()=>[p(" "+h(e.$pgettext("st",s.label||s.type)),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])],64)}const ie=D(se,[["render",le],["__scopeId","data-v-ebb64d07"]]),re={components:{SchemaItems:ie},props:{embed:{type:Boolean,default:!1},filter:{type:Object,default:()=>({})}},emits:["select"],inject:["debounce"],data(){return{items:[],term:"",sort:{column:"ID",order:"DESC"},page:1,last:1,limit:100,vschemas:!1,checked:!1,loading:!0,trash:!1}},setup(){const e=N();return{auth:H(),messages:e}},created(){this.search(),this.searchd=this.debounce(this.search,500)},computed:{canTrash(){return this.items.some(e=>e._checked&&!e.deleted_at)},isChecked(){return this.items.some(e=>e._checked)},isTrashed(){return this.items.some(e=>e._checked&&e.deleted_at)}},methods:{add(e){if(this.embed||!this.auth.can("element:add")){this.messages.add(this.$gettext("Permission denied"),"error");return}return this.$apollo.mutate({mutation:$`mutation($input: ElementInput!) {
            addElement(input: $input) {
              id
              lang
              name
              type
              data
              editor
              created_at
              updated_at
              deleted_at
            }
          }`,variables:{input:{type:e.type,name:this.$gettext("New shared element"),data:"{}"}}}).then(t=>{var o;if(t.errors)throw t.errors;const a=((o=t.data)==null?void 0:o.addElement)||{};return a.data=JSON.parse(a.data)||{},a.published=!0,this.vschemas=!1,this.items.unshift(a),this.$emit("select",a),this.invalidate(),a}).catch(t=>{this.$log("ElementListItems::add(): Error adding shared element",t)})},drop(e){if(!this.auth.can("element:drop")){this.messages.add(this.$gettext("Permission denied"),"error");return}const t=e?[e]:this.items.filter(a=>a._checked);t.length&&this.$apollo.mutate({mutation:$`
            mutation($id: [ID!]!) {
              dropElement(id: $id) {
                id
              }
            }
          `,variables:{id:t.map(a=>a.id)}}).then(a=>{if(a.errors)throw a.errors;this.invalidate(),this.search()}).catch(a=>{this.messages.add(this.$gettext("Error trashing shared element"),"error"),this.$log("ElementListItems::drop(): Error trashing shared element",t,a)})},invalidate(){const e=this.$apollo.provider.defaultClient.cache;e.evict({id:"ROOT_QUERY",fieldName:"elements"}),e.gc()},keep(e){if(!this.auth.can("element:keep")){this.messages.add(this.$gettext("Permission denied"),"error");return}const t=e?[e]:this.items.filter(a=>a._checked);t.length&&this.$apollo.mutate({mutation:$`
            mutation($id: [ID!]!) {
              keepElement(id: $id) {
                id
              }
            }
          `,variables:{id:t.map(a=>a.id)}}).then(a=>{if(a.errors)throw a.errors;t.forEach(o=>{o.deleted_at=null}),this.invalidate(),this.search()}).catch(a=>{this.messages.add(this.$gettext("Error restoring shared element"),"error"),this.$log("ElementListItems::keep(): Error restoring shared element",t,a)})},publish(e){if(!this.auth.can("element:publish")){this.messages.add(this.$gettext("Permission denied"),"error");return}const t=e?[e]:this.items.filter(a=>a._checked&&a.id&&!a.published);t.length&&this.$apollo.mutate({mutation:$`mutation ($id: [ID!]!) {
            pubElement(id: $id) {
              id
            }
          }`,variables:{id:t.map(a=>a.id)}}).then(a=>{if(a.errors)throw a.errors;t.forEach(o=>{o.published=!0,o._checked=!1}),this.invalidate(),this.search()}).catch(a=>{this.messages.add(this.$gettext("Error publishing shared element"),"error"),this.$log("ElementListItems::publish(): Error publishing shared element",t,a)})},purge(e){if(!this.auth.can("element:purge")){this.messages.add(this.$gettext("Permission denied"),"error");return}const t=e?[e]:this.items.filter(a=>a._checked);t.length&&this.$apollo.mutate({mutation:$`
            mutation($id: [ID!]!) {
              purgeElement(id: $id) {
                id
              }
            }
          `,variables:{id:t.map(a=>a.id)}}).then(a=>{if(a.errors)throw a.errors;this.invalidate(),this.search()}).catch(a=>{this.messages.add(this.$gettext("Error purging shared element"),"error"),this.$log("ElementListItems::purge(): Error purging shared element",t,a)})},search(){if(!this.auth.can("element:view"))return this.messages.add(this.$gettext("Permission denied"),"error"),Promise.resolve([]);const e=this.filter.publish||null,t=this.filter.trashed||"WITHOUT",a={...this.filter};return delete a.publish,delete a.trashed,this.term&&(a.any=this.term),this.loading=!0,this.$apollo.query({query:$`
            query($filter: ElementFilter, $sort: [QueryElementsSortOrderByClause!], $limit: Int!, $page: Int!, $trashed: Trashed, $publish: Publish) {
              elements(filter: $filter, sort: $sort, first: $limit, page: $page, trashed: $trashed, publish: $publish) {
                data {
                  id
                  lang
                  name
                  type
                  data
                  editor
                  created_at
                  updated_at
                  deleted_at
                  latest {
                    id
                    published
                    publish_at
                    data
                    editor
                    created_at
                  }
                }
                paginatorInfo {
                  lastPage
                }
              }
            }
          `,variables:{filter:a,page:this.page,limit:this.limit,sort:[this.sort],trashed:t,publish:e}}).then(o=>{var n;if(o.errors)throw o.errors;const r=o.data.elements||{};return this.last=((n=r.paginatorInfo)==null?void 0:n.lastPage)||1,this.items=[...r.data||[]].map(d=>{var m,v,C,P,L,O;const s=(m=d.latest)!=null&&m.data?JSON.parse((v=d.latest)==null?void 0:v.data):{...d,data:JSON.parse(d.data||"{}")};return Object.assign(s,{id:d.id,deleted_at:d.deleted_at,created_at:d.created_at,updated_at:((C=d.latest)==null?void 0:C.created_at)||d.updated_at,editor:((P=d.latest)==null?void 0:P.editor)||d.editor,published:((L=d.latest)==null?void 0:L.published)??!0,publish_at:((O=d.latest)==null?void 0:O.publish_at)||null,latest:d.latest})}),this.checked=!1,this.loading=!1,this.items}).catch(o=>{this.messages.add(this.$gettext("Error fetching shared elements"),"error"),this.$log("ElementListItems::search(): Error fetching shared element",o)})},title(e){const t=[];return e.publish_at&&t.push("Publish at: "+new Date(e.publish_at).toLocaleDateString()),t.join(`
`)},toggle(){this.items.forEach(e=>{e._checked=!e._checked})}},watch:{filter:{deep:!0,handler(){this.search()}},term(){this.searchd()},page(){this.search()},sort(){this.search()}}},ne={class:"header"},de={class:"bulk"},oe={class:"search"},ue={class:"layout"},he=["onClick","title"],me={class:"item-text"},ce={class:"item-head"},pe={key:0,class:"item-lang"},fe={class:"item-title"},ge={class:"item-type item-subtitle"},ve={class:"item-aux"},be={class:"item-editor"},ke={class:"item-modified item-subtitle"},_e={key:0,class:"loading"},xe={key:1,class:"notfound"},$e={key:3,class:"btn-group"};function ye(e,t,a,o,r,n){const d=K("SchemaItems");return u(),k(x,null,[f("div",ne,[f("div",de,[i(F,{modelValue:r.checked,"onUpdate:modelValue":t[0]||(t[0]=s=>r.checked=s),onClick:t[1]||(t[1]=W(s=>n.toggle(),["stop"]))},null,8,["modelValue"]),i(w,{location:"bottom left"},{activator:l(({props:s})=>[i(c,S({"append-icon":"mdi-menu-down",variant:"text"},s),{default:l(()=>[p(h(e.$gettext("Actions")),1)]),_:2},1040)]),default:l(()=>[i(I,null,{default:l(()=>[V(i(g,null,{default:l(()=>[i(c,{"prepend-icon":"mdi-publish",variant:"text",onClick:t[2]||(t[2]=s=>n.publish())},{default:l(()=>[p(h(e.$gettext("Publish")),1)]),_:1})]),_:1},512),[[E,n.isChecked&&o.auth.can("element:publish")]]),!this.embed&&o.auth.can("element:add")?(u(),b(g,{key:0},{default:l(()=>[i(c,{"prepend-icon":"mdi-folder-plus",variant:"text",onClick:t[3]||(t[3]=s=>r.vschemas=!0)},{default:l(()=>[p(h(e.$gettext("Add element")),1)]),_:1})]),_:1})):_("",!0),V(i(g,null,{default:l(()=>[i(c,{"prepend-icon":"mdi-delete",variant:"text",onClick:t[4]||(t[4]=s=>n.drop())},{default:l(()=>[p(h(e.$gettext("Delete")),1)]),_:1})]),_:1},512),[[E,n.canTrash&&o.auth.can("element:drop")]]),V(i(g,null,{default:l(()=>[i(c,{"prepend-icon":"mdi-delete-restore",variant:"text",onClick:t[5]||(t[5]=s=>n.keep())},{default:l(()=>[p(h(e.$gettext("Restore")),1)]),_:1})]),_:1},512),[[E,n.isTrashed&&o.auth.can("element:keep")]]),V(i(g,null,{default:l(()=>[i(c,{"prepend-icon":"mdi-delete-forever",variant:"text",onClick:t[6]||(t[6]=s=>n.purge())},{default:l(()=>[p(h(e.$gettext("Purge")),1)]),_:1})]),_:1},512),[[E,n.isChecked&&o.auth.can("element:purge")]])]),_:1})]),_:1})]),f("div",oe,[i(z,{modelValue:r.term,"onUpdate:modelValue":t[7]||(t[7]=s=>r.term=s),"prepend-inner-icon":"mdi-magnify",variant:"underlined",label:e.$gettext("Search for"),"hide-details":"",clearable:""},null,8,["modelValue","label"])]),f("div",ue,[i(w,{location:"bottom right"},{activator:l(({props:s})=>[i(c,S(s,{title:e.$gettext("Sort by"),"append-icon":"mdi-menu-down","prepend-icon":"mdi-sort",variant:"text"}),{default:l(()=>{var m,v,C;return[p(h(((m=r.sort)==null?void 0:m.column)==="ID"?((v=r.sort)==null?void 0:v.order)==="DESC"?e.$gettext("latest"):e.$gettext("oldest"):((C=r.sort)==null?void 0:C.column)||""),1)]}),_:2},1040,["title"])]),default:l(()=>[i(I,null,{default:l(()=>[i(g,null,{default:l(()=>[i(c,{variant:"text",onClick:t[8]||(t[8]=s=>r.sort={column:"ID",order:"DESC"})},{default:l(()=>[p(h(e.$gettext("latest")),1)]),_:1})]),_:1}),i(g,null,{default:l(()=>[i(c,{variant:"text",onClick:t[9]||(t[9]=s=>r.sort={column:"ID",order:"ASC"})},{default:l(()=>[p(h(e.$gettext("oldest")),1)]),_:1})]),_:1}),i(g,null,{default:l(()=>[i(c,{variant:"text",onClick:t[10]||(t[10]=s=>r.sort={column:"NAME",order:"ASC"})},{default:l(()=>[p(h(e.$gettext("name")),1)]),_:1})]),_:1}),i(g,null,{default:l(()=>[i(c,{variant:"text",onClick:t[11]||(t[11]=s=>r.sort={column:"TYPE",order:"ASC"})},{default:l(()=>[p(h(e.$gettext("type")),1)]),_:1})]),_:1}),i(g,null,{default:l(()=>[i(c,{variant:"text",onClick:t[12]||(t[12]=s=>r.sort={column:"EDITOR",order:"ASC"})},{default:l(()=>[p(h(e.$gettext("editor")),1)]),_:1})]),_:1})]),_:1})]),_:1})])]),i(I,{class:"items"},{default:l(()=>[(u(!0),k(x,null,y(r.items,(s,m)=>(u(),b(g,{key:m},{default:l(()=>[i(F,{modelValue:s._checked,"onUpdate:modelValue":v=>s._checked=v,class:T([{draft:!s.published},"item-check"])},null,8,["modelValue","onUpdate:modelValue","class"]),i(w,null,{activator:l(({props:v})=>[i(c,S({ref_for:!0},v,{title:e.$gettext("Actions"),icon:"mdi-dots-vertical",class:"item-menu",variant:"flat"}),null,16,["title"])]),default:l(()=>[i(I,null,{default:l(()=>[V(i(g,null,{default:l(()=>[i(c,{"prepend-icon":"mdi-publish",variant:"text",onClick:v=>n.publish(s)},{default:l(()=>[p(h(e.$gettext("Publish")),1)]),_:2},1032,["onClick"])]),_:2},1536),[[E,!s.deleted_at&&!s.published&&this.auth.can("element:publish")]]),!s.deleted_at&&this.auth.can("element:drop")?(u(),b(g,{key:0},{default:l(()=>[i(c,{"prepend-icon":"mdi-delete",variant:"text",onClick:v=>n.drop(s)},{default:l(()=>[p(h(e.$gettext("Delete")),1)]),_:2},1032,["onClick"])]),_:2},1024)):_("",!0),s.deleted_at&&this.auth.can("element:keep")?(u(),b(g,{key:1},{default:l(()=>[i(c,{"prepend-icon":"mdi-delete-restore",variant:"text",onClick:v=>n.keep(s)},{default:l(()=>[p(h(e.$gettext("Restore")),1)]),_:2},1032,["onClick"])]),_:2},1024)):_("",!0),this.auth.can("element:purge")?(u(),b(g,{key:2},{default:l(()=>[i(c,{"prepend-icon":"mdi-delete-forever",variant:"text",onClick:v=>n.purge(s)},{default:l(()=>[p(h(e.$gettext("Purge")),1)]),_:2},1032,["onClick"])]),_:2},1024)):_("",!0)]),_:2},1024)]),_:2},1024),f("div",{class:T(["item-content",{trashed:s.deleted_at}]),onClick:v=>e.$emit("select",s),title:n.title(s)},[f("div",me,[f("div",ce,[s.lang?(u(),k("span",pe,h(s.lang),1)):_("",!0),s.publish_at?(u(),b(X,{key:1,class:"publish-at",icon:"mdi-clock-outline"})):_("",!0),f("span",fe,h(s.name),1)]),f("div",ge,h(s.type),1)]),f("div",ve,[f("div",be,h(s.editor),1),f("div",ke,h(new Date(s.updated_at).toLocaleString()),1)])],10,he)]),_:2},1024))),128))]),_:1}),r.loading?(u(),k("p",_e,[p(h(e.$gettext("Loading"))+" ",1),t[18]||(t[18]=f("svg",{class:"spinner",width:"32",height:"32",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[f("circle",{class:"spin1",cx:"4",cy:"12",r:"3"}),f("circle",{class:"spin1 spin2",cx:"12",cy:"12",r:"3"}),f("circle",{class:"spin1 spin3",cx:"20",cy:"12",r:"3"})],-1))])):_("",!0),!r.loading&&!r.items.length?(u(),k("p",xe,h(e.$gettext("No entries found")),1)):_("",!0),r.last>1?(u(),b(G,{key:2,modelValue:r.page,"onUpdate:modelValue":t[13]||(t[13]=s=>r.page=s),length:r.last},null,8,["modelValue","length"])):_("",!0),!this.embed&&this.auth.can("element:add")?(u(),k("div",$e,[i(c,{onClick:t[14]||(t[14]=s=>r.vschemas=!0),title:e.$gettext("Add element"),icon:"mdi-view-grid-plus",color:"primary",variant:"flat"},null,8,["title"])])):_("",!0),(u(),b(Y,{to:"body"},[i(Q,{modelValue:r.vschemas,"onUpdate:modelValue":t[16]||(t[16]=s=>r.vschemas=s),onAfterLeave:t[17]||(t[17]=s=>r.vschemas=!1),scrollable:"",width:"auto"},{default:l(()=>[i(d,{type:"content",onAdd:t[15]||(t[15]=s=>n.add(s))})]),_:1},8,["modelValue"])]))],64)}const Ie=D(re,[["render",ye],["__scopeId","data-v-05f25b08"]]);export{Ie as E,Ee as F,ie as S};
